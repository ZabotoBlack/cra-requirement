import re


def _sanitize_cpe_token(value: str) -> str:
    """Normalize user/vendor tokens to CPE-safe lowercase segments."""
    cleaned = re.sub(r"[^a-zA-Z0-9._-]+", "_", (value or "").strip().lower())
    return cleaned.strip("_") or "*"


def build_cpe(vendor: str, product: str, version: str = "*") -> str:
    """Build a CPE 2.3 operating-system style identifier from device metadata."""
    vendor_token = _sanitize_cpe_token(vendor)
    product_token = _sanitize_cpe_token(product)
    version_token = _sanitize_cpe_token(version) if version else "*"
    return f"cpe:2.3:o:{vendor_token}:{product_token}:{version_token}:*:*:*:*:*:*:*"


def match_cpe(cpe_string: str, nvd_client) -> str | None:
    """Resolve a best-match canonical CPE from NVD search results."""
    if not cpe_string or not cpe_string.startswith("cpe:2.3:"):
        return None

    parts = cpe_string.split(":")
    if len(parts) < 7:
        return None

    vendor = parts[3]
    product = parts[4]
    version = parts[5]
    keyword = " ".join([p for p in [vendor, product, None if version == "*" else version] if p])

    matches = nvd_client.search_cpes(keyword, limit=10)
    if not matches:
        return None

    for match in matches:
        cpe_name = match.get("cpe")
        if not cpe_name:
            continue
        cpe_parts = cpe_name.split(":")
        if len(cpe_parts) < 6:
            continue
        m_vendor = cpe_parts[3].lower()
        m_product = cpe_parts[4].lower()
        if vendor in m_vendor and product in m_product:
            return cpe_name

    return matches[0].get("cpe")
