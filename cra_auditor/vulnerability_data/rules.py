import logging
from pathlib import Path

import yaml


class VendorRules:
    """Load and query vendor-specific compliance metadata from YAML rules."""

    def __init__(self, rules_path: str | None = None):
        """Initialize rules storage and load initial rule data from disk."""
        self._logger = logging.getLogger(__name__)
        self.rules_path = Path(rules_path) if rules_path else Path(__file__).resolve().parents[1] / "data" / "vendor_rules.yaml"
        self._data = {}
        self.reload()

    def reload(self):
        """Reload vendor rule definitions from YAML into memory."""
        if not self.rules_path.exists():
            self._data = {}
            return
        try:
            with self.rules_path.open("r", encoding="utf-8") as handle:
                self._data = yaml.safe_load(handle) or {}
        except yaml.YAMLError:
            self._logger.error("Failed to parse vendor rules YAML from %s; falling back to empty rules.", self.rules_path, exc_info=True)
            self._data = {}
        except Exception:
            self._logger.error("Unexpected error loading vendor rules from %s in reload(); falling back to empty rules.", self.rules_path, exc_info=True)
            self._data = {}

    def _lookup(self, section: str, vendor: str, default=None):
        """Perform exact/fuzzy vendor lookup for a specific rules section."""
        if not vendor or vendor == "Unknown":
            return default

        section_map = self._data.get(section, {}) or {}
        vendor_norm = vendor.lower().strip()

        for key, value in section_map.items():
            if key.lower() == vendor_norm:
                return value

        for key, value in section_map.items():
            k = key.lower()
            if k in vendor_norm or vendor_norm in k:
                return value

        return default

    def get_sbom_status(self, vendor: str) -> str:
        """Return vendor SBOM publication status (available/unavailable/unknown)."""
        return self._lookup("sbom_status", vendor, default="unknown")

    def get_sbom_url(self, vendor: str) -> str | None:
        """Return vendor SBOM portal URL when known."""
        return self._lookup("sbom_urls", vendor, default=None)

    def get_security_txt_status(self, vendor: str) -> str:
        """Return vendor security.txt publication status."""
        return self._lookup("security_txt_status", vendor, default="unknown")

    def get_security_txt_url(self, vendor: str) -> str | None:
        """Return vendor disclosure policy URL for security.txt when available."""
        return self._lookup("security_txt_urls", vendor, default=None)

    def get_firmware_update_url(self, vendor: str) -> str | None:
        """Return vendor firmware update URL if configured."""
        return self._lookup("firmware_update_urls", vendor, default=None)
