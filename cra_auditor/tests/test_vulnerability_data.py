import os
import sys
import tempfile
import unittest
from unittest.mock import MagicMock, patch

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from vulnerability_data.cpe import build_cpe
from vulnerability_data.nvd import NVDClient
from vulnerability_data.rules import VendorRules


class TestCPEHelpers(unittest.TestCase):
    def test_build_cpe(self):
        cpe = build_cpe("Microsoft", "Windows 10", "22H2")
        self.assertEqual(cpe, "cpe:2.3:o:microsoft:windows_10:22h2:*:*:*:*:*:*:*")


class TestVendorRules(unittest.TestCase):
    def test_rules_load_and_lookup(self):
        rules = VendorRules()
        self.assertEqual(rules.get_sbom_status("Philips"), "available")
        self.assertEqual(rules.get_security_txt_status("Tuya"), "unavailable")
        self.assertEqual(rules.get_firmware_update_url("Shelly"), "https://shelly-api-docs.shelly.cloud/gen2/changelog/")


class TestNVDClient(unittest.TestCase):
    @patch("vulnerability_data.nvd.requests.Session.get")
    def test_get_cves_for_cpe_parses_response(self, mock_get):
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "vulnerabilities": [
                {
                    "cve": {
                        "id": "CVE-2024-0001",
                        "descriptions": [{"lang": "en", "value": "Critical test vulnerability"}],
                        "metrics": {
                            "cvssMetricV31": [
                                {
                                    "cvssData": {"baseScore": 9.8, "baseSeverity": "CRITICAL"}
                                }
                            ]
                        },
                    }
                }
            ]
        }
        mock_get.return_value = mock_response

        with tempfile.TemporaryDirectory() as tmp:
            cache_path = os.path.join(tmp, "nvd_cache.json")
            client = NVDClient(api_key="dummy", cache_path=cache_path)
            cves = client.get_cves_for_cpe("cpe:2.3:o:microsoft:windows_10:*:*:*:*:*:*:*:*", min_cvss=9.0, limit=5)

        self.assertEqual(len(cves), 1)
        self.assertEqual(cves[0]["id"], "CVE-2024-0001")
        self.assertEqual(cves[0]["severity"], "CRITICAL")


if __name__ == "__main__":
    unittest.main()
